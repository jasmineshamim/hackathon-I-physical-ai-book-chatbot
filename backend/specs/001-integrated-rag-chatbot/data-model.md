# Data Model: Integrated RAG Chatbot for a Published Book

## Entities

### Book Content Chunk
- **Description**: A segment of the book content with associated metadata
- **Fields**:
  - `id`: UUID (Primary Key)
  - `content`: Text (the actual chunk content)
  - `book_id`: String (identifier for the book)
  - `chunk_index`: Integer (sequential position in the book)
  - `page_number`: Integer (page reference in the original book)
  - `section_title`: String (section/chapter title)
  - `embedding_vector`: Vector (Cohere embedding vector)
  - `metadata`: JSON (additional metadata like paragraph numbers, etc.)
  - `created_at`: DateTime
  - `updated_at`: DateTime

### Question
- **Description**: A natural language query from a user about the book content
- **Fields**:
  - `id`: UUID (Primary Key)
  - `content`: Text (the actual question)
  - `session_id`: UUID (foreign key to Chat Session)
  - `selected_text`: Text (optional, user-selected text for focused queries)
  - `created_at`: DateTime

### Response
- **Description**: An answer generated by the system based on retrieved book content
- **Fields**:
  - `id`: UUID (Primary Key)
  - `content`: Text (the actual response)
  - `question_id`: UUID (foreign key to Question)
  - `retrieved_chunks`: Array[UUID] (references to Book Content Chunks used)
  - `confidence_score`: Float (confidence in the response accuracy)
  - `created_at`: DateTime

### Chat Session
- **Description**: A sequence of questions and responses between a user and the system
- **Fields**:
  - `id`: UUID (Primary Key)
  - `session_token`: String (identifier for the session, could be anonymous)
  - `book_id`: String (the book this session is for)
  - `created_at`: DateTime
  - `updated_at`: DateTime

### User Selection
- **Description**: A specific portion of text selected by the user for focused questioning
- **Fields**:
  - `id`: UUID (Primary Key)
  - `content`: Text (the selected text)
  - `book_id`: String (identifier for the book)
  - `start_position`: Integer (character position in the book)
  - `end_position`: Integer (character position in the book)
  - `page_range`: String (page range if applicable)
  - `created_at`: DateTime

## Relationships

- Chat Session (1) → (Many) Question
- Question (1) → (1) Response
- Response (Many) → (Many) Book Content Chunk (via retrieved_chunks)
- Book Content Chunk (Many) → (1) Book (via book_id)

## Validation Rules

- Book Content Chunk:
  - Content must be non-empty
  - Embedding vector must match expected dimensions (1024 for Cohere embeddings)
  - Page number must be positive if provided

- Question:
  - Content must be non-empty
  - Content must be between 5 and 500 characters
  - Session ID must reference an existing Chat Session

- Response:
  - Content must be non-empty
  - Confidence score must be between 0.0 and 1.0
  - Question ID must reference an existing Question

- Chat Session:
  - Session token must be unique
  - Book ID must be valid

## State Transitions

- Book Content Chunk: No state transitions (immutable once created)
- Question: No state transitions (immutable once created)
- Response: No state transitions (immutable once created)
- Chat Session: 
  - Active (newly created)
  - Expired (after inactivity period)
- User Selection: No state transitions (immutable once created)